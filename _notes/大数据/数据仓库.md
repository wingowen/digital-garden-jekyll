---
tags:
  - DW
---
[[大数据组件]]

**为了分析数据而创造产生的各种有助于决策的数据模型.**

数据仓库，它不是数据的最终目的地，而是为数据最终的目的地做好准备，这些准备包括对数据的：清洗、转义、分类、重组、合并、拆分、统计等工作。

从 1990 年 Inmon 提出数据仓库概念到今天，数据架构经历了最初的传统数仓架构——离线数仓架构、Lambda 架构、Kappa 架构以及 Flink 的火热带出的流批一体架构，数据架构技术不断演进，本质都是在往流批一体的方向发展，让用户能以最自然、最小的成本完成实时计算。

**传统数仓**

早期，传统的数据库充当数据仓库的角色，通过离线 ETL（Extra、Transform and Load） 定期加载离线数据，然后通过一定的分析模型对数据进行计算并产生结果的模式，大致的数仓架构如下：

![](assets/images/数据仓库.png)

**离线数仓架构**

随着大数据技术的发展，传统的数仓难以承受海量数据，因此业界开始采用大数据技术来承载存储和计算任务，计算以及存储都采用了基于大数据的框架。

![](assets/images/数据仓库-1.png)

从图中，我们可以看到，离线的数仓的架构使用了集合采集、同步、消息队列等技术，采用 Flume 监控日志文件的更新，采用 Kafka 对消息进行缓冲，使得后续框架能够慢慢消费数据，采用 Sqoop 对保存在诸如 MySQL 等数据库中的数据进行同步，使其存储至 HDFS 中。之后，采用 Hive 对数据进行处理。这里，将数据处理分成了五层，每层的处理分别如下：

|层级名称|解释|要求|
|---|---|---|
|ODS（Operation Data Store）|原始数据层|存放原始数据，要求对数据不做任何处理，保持数据原貌|
|DWD（Data Warehouse Detail）|明细数据层|对 ODS 层做数据清洗（去除空值、脏数据等），维度退化、脱敏等。粒度是一行信息代表一次行为，例如一次下单|
|DWS（Data Warehouse Service）|服务数据层|以 DWD 为基础，按天进行轻度汇总。粒度是一行信息代表一天的行为，比如一天内下单的次数|
|DWT（Data Warehouse Topic）|数据主题层|以 DWS 为基础，按主题进行汇总。粒度是一行信息代表累积的行为，例如用户层注册那天开始至今一共下了多少单|
|ADS（Application Data Store）|数据应用层|为各种统计报表提供数据|

最后将处理好的分析数据同步至 MySQL 用于 BI 报表的展示。

**Lambda 机构**

Lambda 架构是由 Storm 的作者 Nathan Marz 提出的一个实时大数据处理框架。Marz 在 Twitter 工作期间开发了著名的实时大数据处理框架 Storm，Lambda 架构是其根据多年进行分布式大数据系统的经验总结提炼而成。Lambda 架构的目标是设计出一个能满足实时大数据系统关键特性的架构，包括有：高容错、低延时和可扩展等。Lambda 架构整合离线计算和实时计算，融合不可变性（Immunability），读写分离和复杂性隔离等一系列架构原则，可集成 Hadoop，Kafka，Storm，Spark，Hbase 等各类大数据组件。

![](assets/images/数据仓库-2.png)

诚然，这个架构在一定程度上满足了当下业界对实时性的部分要求，且 Lambda 架构经历多年的发展，其优点是稳定，对于实时计算部分的计算成本可控，批量处理可以用晚上的时间来整体批量计算，这样把实时计算和离线计算高峰分开，这种架构支撑了数据行业的早期发展，但是它也有一些致命缺点，并在大数据 3.0 时代越来越不适应数据分析业务的需求，原因有几个，第一是实时和批量计算结果不一致会引起数据口径的问题，第二是批量计算在一个单位的计算窗口时间内无法完成，第三是开发和维护两个计算队列成本过高，且逻辑复杂，第四是由于计算会产生大量中间结果表，对服务器的存储压力构成一定的威胁。

**Kappa 架构**

2014 年 Jay Kreps 在一次研讨会上指出了一些 Lambda 架构间的差异，大数据世界自此迎来了另一个备选架构，它的代码量更少，特别适用于那些使用多层 Lambda 架构显得有些奢侈的企业场景。Kappa 架构不能被简单视作 Lambda 架构的替代品，相反，它是在离线层对满足业务需求不是必须项时的一个备选项,该架构适合实时处理不同事件。

![](assets/images/数据仓库-3.png)

此架构解决了 Lambda 架构中的弊病，其在数据需要重新处理或数据变更时，通过 Kafka 框架保留历史数据的机制，将历史数据重新处理来完成有关操作。这种方式有点在于将离线批处理层从架构中去除，能够更加高效地进行计算。缺点在于缺少了离线层，可能导致数据处理或数据库更新时发生错误，因此需要添加异常管理来调节矛盾，恢复数据，另外，流式重新处理历史数据的吞吐能力低于离线批处理，这也是这个架构的缺点之一。
# 建模方法论

## ER 模型

![](assets/images/数仓建模方法论-3.png)

ER，Entity Relationship。

站在企业角度面向主题的抽象，而不是针对某个具体业务流程的实体对象关系的抽象（OLTP）。

目的是整合数据，将各个系统中的数据以整个企业角度按主题进行相似性组合和合并，并进行一致性处理，为数据分析决策服务，并不能直接用于分析决策。

案例：FS-LDM，Financial Services Logical Data Model

![](assets/images/数仓建模方法论-1.png)

## 纬度模型

![](assets/images/数仓建模方法论-4.png)

案例：The Data Warehouse Toolkit - The Complete Guide to Dimensional Modeling

典型代表

 - 星形模型：以事实表为中心，所有维度直接关联在事实表上，呈星型分布
 - 雪花模型：维度表上又关联了其他维度表
 - 星座模型：多张事实表共享纬度表

设计步骤

1. 选择业务过程。可以是单个业务事件，某个事件状态或者相关业务组成的业务流程
2. 选择粒度。粒度是纬度的一个组合
3. 识别纬表。基于粒度设计纬表以及纬度属性，用于分析时进行分组和筛选
4. 选择事实。确定分析需要衡量的指标

WHY

- 为什么维度模型适用于商业分析？
- 维度模型的基本设计理念是怎样的？
- 如何记录所有的历史数据与变更？
- 如何把控数据的质量？

WHAT

维度模型是专为统计分析优化的数据模型，维度模型的设计由业务流程驱动，每一个业务流程对应一张事实表以及若干维度表。

- 指标记录在事实表中，如交易金额、利润、销售量等
- 过滤与分组的条件则记录在维度表中，如交易时间，地区，商品种类等
- 事实表的每条记录中，除了指标数据，还保存连接各维度表的外键

**纬度模型是一种折中模型**，下面看两种比较极端的模型情况：

对于查询，最简单的模型就是一张超宽表，所有查询条件都有相应的表内字段，不需要任何 join；这样的模型维护成本高，有大量冗余数据，经常要修改表结构或是现有数据来适应业务的变化。

经典 ER 模型的表维护成本低，无冗余数据，但统计查询需要大量的 join；业务人员不但要理解错综复杂的表与表之间的网状关系，而且构建统计查询的 SQL 语句的难度也很大，还要忍受复杂 SQL 语句低下的执行效率。

维度模型就是这两者之间的一个折中。对业务人员来说，查询时有统一的语句结构，并且最多只有一级 join；对维护人员来说，为应对业务需求的变化，大部分数据表的更改都发生在数据量较小的维度表上。

### 事实表

TWO KEY POINTS

- 定义指标
	- 可加
	- 半可加、不可加
- 确定每条记录的粒度


类型

- 事务事实表
- 周期快照事实表
- 累积快照事实表
### 维度表

维度表用于辅助描述事实发生的场景，为事实增添了 who, what, where, when, how 和 why 这些细节，主要用于过滤与分组。维度属性设计是数据仓库质量的关键。

推荐使用描述性文字

扁平层级

例如，一个大企业之下会有若干品牌，每个品牌之下有商品分类，每个分类之下再有单类的商品。以 ER 模型的设计思路，品牌，分类以及商品都应该是单独的表，商品用外键连接分类，分类再用外键连接品牌。而在设计维度表时，我们应该只建一张商品表，将品牌名，分类名直接保存在商品表中。虽然这会导致大量的数据冗余，但这张维度表对分析人员来说更简单易用。

**日期纬度表（统一）

**纬度表更新**

代理主键（存入事实表），记录的生效日期（Row Effective Date），记录的失效日期（Row Expiration Date）, 以及是否为当前记录的标志位（Current Row Indicator）。

区分数值型维度与事实

- 通常用于查询约束条件和分组统计，则作为维度属性
- 通常用于参与度量的计算，则作为事实

主要目标是维度一致性，其表现形式主要如下

- 共享维表
- 一致性上卷
- 交叉属性

维表统一

维表拆分整合

维度变化

维度归档

### 数据质量管理

- 字段测试
- 结构测试
- 商业逻辑测试

创建一张质量错误事实表，记录每一个质量错误，并定期审查。

***
DATA VALUE 模型
ANCHOR 模型

# 体系结构

![](assets/images/OneData.png)

原子指标 = 业务过程（动作）+度量，如支付（事件）金额（度量）。

![](assets/images/体系架构.png)

# 指标体系

派生指标可以理解为对原子指标业务统计范围的圈定
- 原子指标：支付金额
- 派生指标：最近 1 天海外买家支付金额，其中 1 天为时间周期，海外为修饰词，买家为维度

事件周期修饰词

派生指标种类

- 事务型：对业务活动进行衡量的指标
- 存量型：对实体对象某些状态的统计
- 复合型：

# 模型设计

![](assets/images/模型设计.png)

![](assets/images/模型设计-1.png)

# 需求调研

数据需求驱动数据仓库团队去了解业务系统的业务数据。

举例：分析师需要了解大淘宝（淘宝、天猫、天猫国际） 级类目的成交金额。当获知这个需求后，我们要分析根据什么（维度）汇总，以及汇总什么（度量），这里类目是维度，金额是度量：明细数据和汇总数据应该怎样设计？这是一个公用的报表吗？是需要沉淀到汇总里面，还是在报表工具中进行汇总？

# 总线矩阵

在进行充分的业务调研和需求调研后，就要构建总线矩阵了。需要做两件事情 ：明确每个数据域下有哪些业务过程；业务过程与哪些维度相关，并定义每个数据域下的业务过程和维度。

一个总线矩阵的例子。
![](assets/images/构建总线矩阵.png)

在维度建模中，将度量称为“事实”，将环境描述为“维度”，维度是用于分析事实所需要的多样环境。

维度属性是查询约束条件、分组和报表标签生成的基本来源，是数据易用性的关键。